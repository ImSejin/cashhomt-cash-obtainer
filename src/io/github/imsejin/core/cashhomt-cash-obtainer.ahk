/*
 * <ìºì‹œí™ˆíŠ¸> ìºì‹œì ë¦½ ë§¤í¬ë¡œ
 * 
 * OS: 				Microsoft Windows 10
 * AndroidVersion: 	Android 7+
 * NoxVersion: 		6.6.0.1+
 * Display:			w=360 h=600 dpi=120
 * Setting:			Allways_Vertical_Screen(í•­ìƒ ì„¸ë¡œí™”ë©´ìœ¼ë¡œ ì‚¬ìš©)
 */
#Include %A_Temp%\AutoHotKey\cashhomt-cash-obtainer\lib\Gdip.ahk ; https://autohotkey.com/board/topic/29449-gdi-standard-library-145-by-tic
#Include %A_Temp%\AutoHotKey\cashhomt-cash-obtainer\lib\Gdip_ImageSearch.ahk
#Include %A_Temp%\AutoHotKey\cashhomt-cash-obtainer\lib\Utils.ahk

#SingleInstance Force
#NoEnv

SetWorkingDir %A_ScriptDir%
SetBatchLines -1

; ------------------------------------- ì»´íŒŒì¼ íŒ¨í‚¤ì§• ---------------------------------------

; ë°°í¬ ê²½ë¡œ
global DISTRIBUTION_PATH := A_Temp . "\AutoHotKey\cashhomt-cash-obtainer\"

; ìµœì´ˆ ì‹¤í–‰ ì‹œ, íŒ¨í‚¤ì§€ ë°°í¬ì— ëŒ€í•œ ë™ì˜ ì—¬ë¶€ë¥¼ ë°›ëŠ”ë‹¤
isNotExist := FileExist(DISTRIBUTION_PATH . "cashhomt-macro.ini") = "" ? true : false
IniRead, agreement, % DISTRIBUTION_PATH . "cashhomt-macro.ini", DISTRIBUTION, consent ; , false
didNotAgree := agreement == "true" ? false : true

if (isNotExist || didNotAgree)
{
	; ë™ì˜ ë¬¸êµ¬ë¥¼ ì‘ì„±í•œë‹¤
	msg =
	(
The libraries must be distributed to the path below to run this program. Do you agree?
(If not, this program will be terminated.)
		
============ DISTRIBUTION PATH ============
%DISTRIBUTION_PATH%

=============== LIBRARIES ===============

	)
	packages := ["lib\Gdip.ahk", "lib\Gdip_ImageSearch.ahk", "lib\Utils.ahk", "img\btn_boost.bmp", "img\ghost.bmp", "img\btn_go_page.bmp", "img\ico_cashhomet.bmp", "img\btn_failed.bmp", "img\finish.bmp"]
	for k, v in packages
	{
		;~ msg .= A_Temp "\AutoHotKey\" v "`n"
		msg .= ".\" . v . "`n"
	}
	
	; ë¼ì´ë¸ŒëŸ¬ë¦¬ ë°°í¬ì— ë™ì˜í•˜ì§€ ì•Šìœ¼ë©´ í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•œë‹¤
	MsgBox, % 4+48, % "Notice", % msg
	IfMsgBox, No
	{
		ExitApp
	}
	
	; ë¼ì´ë¸ŒëŸ¬ë¦¬ ë°°í¬ ë™ì˜ì„œë¥¼ ìƒì„±í•œë‹¤
	IfNotExist, % DISTRIBUTION_PATH
	{
		FileCreateDir, % DISTRIBUTION_PATH
	}
	IniWrite, true, % DISTRIBUTION_PATH . "cashhomt-macro.ini", DISTRIBUTION, consent
	FileSetAttrib, +H, % DISTRIBUTION_PATH . "cashhomt-macro.ini"
}

; íŒ¨í‚¤ì§•í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë° ì´ë¯¸ì§€ë¥¼ ë°°í¬í•  ë””ë ‰í„°ë¦¬ë¥¼ ìƒì„±í•œë‹¤
IfNotExist, % DISTRIBUTION_PATH . "lib\"
{
	FileCreateDir, % DISTRIBUTION_PATH . "lib\"
}
IfNotExist, % DISTRIBUTION_PATH . "img\"
{
	FileCreateDir, % DISTRIBUTION_PATH . "img\"
}
IfNotExist, % DISTRIBUTION_PATH . "log\"
{
	FileCreateDir, % DISTRIBUTION_PATH . "log\"
}

; íŒ¨í‚¤ì§•í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë° ì´ë¯¸ì§€ë¥¼ ë°°í¬í•œë‹¤
FileInstall, ..\lib\Gdip.ahk, %DISTRIBUTION_PATH%\lib\Gdip.ahk, 0
FileInstall, ..\lib\Gdip_ImageSearch.ahk, %DISTRIBUTION_PATH%\lib\Gdip_ImageSearch.ahk, 0
FileInstall, ..\lib\Utils.ahk, %DISTRIBUTION_PATH%\lib\Utils.ahk, 0

FileInstall, ..\img\btn_boost.bmp, %DISTRIBUTION_PATH%\img\btn_boost.bmp, 0
FileInstall, ..\img\ghost.bmp, %DISTRIBUTION_PATH%\img\ghost.bmp, 0
FileInstall, ..\img\btn_go_page.bmp, %DISTRIBUTION_PATH%\img\btn_go_page.bmp, 0
FileInstall, ..\img\ico_cashhomet.bmp, %DISTRIBUTION_PATH%\img\ico_cashhomet.bmp, 0
FileInstall, ..\img\btn_failed.bmp, %DISTRIBUTION_PATH%\img\btn_failed.bmp, 0
FileInstall, ..\img\finish.bmp, %DISTRIBUTION_PATH%\img\finish.bmp, 0

; ------------------------------------------------------------------------------------------

; ------------------------------------------ GUI -------------------------------------------

; Generated by AutoGUI 2.6.2
Gui Add, GroupBox, x8 y2 w249 h97, Controller ;
Gui Add, Button, x24 y16 w57 h51 gStart, ¢º ; â–¶
Gui Add, Text, x16 y72 w72 h16 +0x200, Start / Ctrl+[
Gui Add, Button, x104 y16 w56 h52 gStop, || 
Gui Add, Text, x96 y72 w72 h17 +0x200, Stop / Ctrl+]
Gui Add, Button, x184 y16 w56 h52 gExit, ¡á ; â– 
Gui Add, Text, x176 y72 w70 h15 +0x200, Exit / Ctrl+\
Gui Add, GroupBox, x8 y104 w249 h49, Parameter
Gui Add, Edit, x24 y123 w160 h18 gNameReceiver vVarNm, name
Gui Add, Edit, x191 y123 w49 h18 gIndexReceiver vVarIdx, index

Gui Show, w265 h160, cashhomt-cash-obtainer
Return

; ------------------------------------------------------------------------------------------

; ---------------------------------------- ì „ì—­ë³€ìˆ˜ ----------------------------------------

; Nox ì¸ìŠ¤í„´ìŠ¤ëª…
global appNm
; Nox ì¸ìŠ¤í„´ìŠ¤ ìˆœì„œë²ˆí˜¸
global instIdx
; ê´‘ê³  ëŒ€ê¸°ì¤‘ì¸ê°€?
global isWaiting
; ë§¤í¬ë¡œë¥¼ ì •ì§€í–ˆëŠ”ê°€?
global isStopped
; ìºì‹œì ë¦½ ë²„íŠ¼ ì´ë¯¸ì§€
global IMG_CASH_GETTER := DISTRIBUTION_PATH . "img\btn_boost.bmp"
; ê´‘ê³  ëŒ€ê¸°í™”ë©´ ì´ë¯¸ì§€
global IMG_WAITING_AD := DISTRIBUTION_PATH . "img\ghost.bmp"
; ìºì‹œì ë¦½ í˜ì´ì§€ ì´ë™ ë²„íŠ¼ ì´ë¯¸ì§€
global IMG_GO_TO_GETTING_PAGE := DISTRIBUTION_PATH . "img\btn_go_page.bmp"
; ìºì‹œí™ˆíŠ¸ í™ˆ ì•„ì´ì½˜ ì´ë¯¸ì§€
global IMG_APP_ICON := DISTRIBUTION_PATH . "img\ico_cashhomet.bmp"
; ìºì‹œì ë¦½ ì‹¤íŒ¨ í™•ì¸ ë²„íŠ¼ ì´ë¯¸ì§€
global IMG_FAILED_TO_GET := DISTRIBUTION_PATH . "img\btn_failed.bmp"
; ëª¨ë“  ìºì‹œì ë¦½ ì™„ë£Œ ì´ë¯¸ì§€
global IMG_FINISH := DISTRIBUTION_PATH . "img\finish.bmp"

; ------------------------------------------------------------------------------------------

; ------------------------------------------ í•¨ìˆ˜ ------------------------------------------

/*
 * ìœˆë„ìš°ë¥¼ í™œì„±í™”í•˜ì—¬ ì´ì „ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.
 */
goBackActively()
{
	; ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì¢Œí‘œ
	x := 390
	y := 530
	
	; í™œì„± ë’¤ë¡œê°€ê¸° í´ë¦­
	WinActivate, %appNm%
	MouseClick, left, x, y
	
	return
}

/*
 * ìœˆë„ìš°ë¥¼ í™œì„±í™”í•˜ì§€ ì•Šê³  ì´ì „ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.
 */
goBackInactively()
{
	; ë¹„í™œì„± ë’¤ë¡œê°€ê¸° í´ë¦­
	ControlClick, X30 Y530, % convertToNoxIndex(instIdx), , , , NA
	
	; Esc í´ë¦­ (ë¯¸ì‘ë™)
	/*
	PostMessage, 0x100, 27, 65537, , %appNm%
	PostMessage, 0x101, 27, 65537, , %appNm%
	ControlSend, , Send {Esc}, %appNm%
	*/
	
	return
}

/*
 * ìˆœì„œë²ˆí˜¸ë¥¼ NoxAppPlayerì˜ ìš°ì¸¡ ë©”ë‰´ì˜ ì»¨íŠ¸ë¡¤ëª…ìœ¼ë¡œ ë³€í™˜í•œë‹¤.
 * 
 * e.g. 0: nox, 1: Nox_1, 2: Nox_2, ...
 */
convertToNoxIndex(index)
{
	result := ""
	
	if (index <= 0)
	{
		result := "nox"
	}
	else
	{
		result := "Nox_" . index
	}
	
	return result
}

; ------------------------------------------------------------------------------------------

; ------------------------------------ íŒŒë¼ë¯¸í„° ì´ˆê¸°í™” -------------------------------------

NameReceiver:
	; GUIì—ì„œ Nox ì¸ìŠ¤í„´ìŠ¤ëª…ì„ ë°›ì•„ì˜¨ë‹¤
	Gui, Submit, NoHide	; <- GuiControlGet would work here too
	appNm := varNm
return

IndexReceiver:
	; GUIì—ì„œ Nox ì¸ìŠ¤í„´ìŠ¤ ìˆœì„œ ë²ˆí˜¸ë¥¼ ë°›ì•„ì˜¨ë‹¤
	Gui, Submit, NoHide	; <- GuiControlGet would work here too
	instIdx := varIdx
return

; ------------------------------------------------------------------------------------------

; ------------------------------------- ìºì‹œì ë¦½ ì‹¤í–‰ --------------------------------------

^[:: 	; ì‹œì‘ ë‹¨ì¶•í‚¤: Ctrl + [
Start: 	; ì‹œì‘ë²„íŠ¼

	; íŒŒë¼ë¯¸í„°ë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ë„ë¡ GUIë¥¼ ë¹„í™œì„±í™”í•œë‹¤
	GuiControl, Disable, varNm
	GuiControl, Disable, varIdx
	
	; ì „ì—­ë³€ìˆ˜ë¥¼ ì´ˆê¸°í™”í•œë‹¤
	isWaiting := false
	isStopped := false
	
	; ë…¹ìŠ¤ì•±í”Œë ˆì´ì–´ ìœˆë„ìš° ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤
	WinGet, noxWinHandle, ID, %appNm%
	
	loop
	{
		; ì¤‘ì§€ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë§¤í¬ë¡œë¥¼ ì¢…ë£Œí•œë‹¤
		if (isStopped)
		{
			break
		}
		
		; 1. `ì ë¦½ë¶€ìŠ¤íŠ¸ ë²„íŠ¼`ì´ ë³´ì´ëŠ”ê°€?
		canGet := Utils.searchImage(IMG_CASH_GETTER, noxWinHandle, x, y)

		if (canGet)
		{
			; 2. ì ë¦½ë²„íŠ¼ì´ ë³´ì´ë©´ ì ë¦½í•œë‹¤
			Utils.clickInactively(x, y, appNm)
		}
		else
		{
			; 3. `ê´‘ê³  ëŒ€ê¸°í™”ë©´`ì´ ë³´ì´ë©´ ê´‘ê³  ëŒ€ê¸°ì¤‘ì„ì„ ì„¤ì •í•œë‹¤
			if (Utils.searchImage(IMG_WAITING_AD, noxWinHandle, x, y))
			{
				isWaiting := true
			}
			
			; 4. `ê´‘ê³  ëŒ€ê¸°í™”ë©´`ì´ ìµœì´ˆë¡œ ë‚˜íƒ€ë‚œ ë’¤, ì‚¬ë¼ì§€ë©´ ê´‘ê³ ê°€ ë…¸ì¶œëœ ê²ƒìœ¼ë¡œ ê°„ì£¼í•œë‹¤
			if (isWaiting)
			{
				; 4-1. ì¼ì • ì‹œê°„ë§ˆë‹¤ ê´‘ê³ ê°€ ì•„ì§ ëŒ€ê¸°ì¤‘ì¸ì§€ í™•ì¸í•œë‹¤
				while (Utils.searchImage(IMG_WAITING_AD, noxWinHandle, x, y))
				{
					sleep, 750
					
					; ì¤‘ì§€ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë§¤í¬ë¡œë¥¼ ì¢…ë£Œí•œë‹¤
					if (isStopped)
					{
						break, 2
					}
				}
				
				; 4-2. ê´‘ê³ í™”ë©´ì´ ì™„ì „íˆ ë¡œë”©ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦°ë‹¤
				; (ì—¬ëŸ¬ ë””ë°”ì´ìŠ¤ê°€ ë™ì‹œì— ê´‘ê³ í™”ë©´ì„ ì¢…ë£Œí•˜ëŠ” ê±¸ ë§‰ëŠ”ë‹¤)
				Random, randomSec, 1500, 2000
				sleep, randomSec
				
				; 4-3. ê´‘ê³ í™”ë©´ì„ ì¢…ë£Œí•œë‹¤
				goBackInactively()
				isWaiting := false
			}
			
			if (Utils.searchImage(IMG_GO_TO_GETTING_PAGE, noxWinHandle, x, y))
			{
				; 5. ë©”ì¸í˜ì´ì§€ë¡œ ì˜ëª» ì´ë™í–ˆìœ¼ë©´ ë‹¤ì‹œ `ìºì‹œì ë¦½í™”ë©´`ìœ¼ë¡œ ì´ë™í•œë‹¤
				Utils.clickInactively(x, y, appNm)
			}
			else if (Utils.searchImage(IMG_APP_ICON, noxWinHandle, x, y))
			{
				; 6. ìºì‹œí™ˆíŠ¸ ì•± ë°–ìœ¼ë¡œ ì´ë™í–ˆìœ¼ë©´ ë‹¤ì‹œ ì•±ì„ ì‹¤í–‰í•œë‹¤
				Utils.clickInactively(x, y, appNm)
			}
			else if (Utils.searchImage(IMG_FAILED_TO_GET, noxWinHandle, x, y))
			{
				; 7. `ìºì‹œì ë¦½ ì‹¤íŒ¨í™”ë©´`ì´ ë…¸ì¶œë˜ë©´ ë‹¤ì‹œ `ìºì‹œì ë¦½í™”ë©´`ìœ¼ë¡œ ì´ë™í•œë‹¤
				Utils.clickInactively(x, y, appNm)
			}
			else if (Utils.searchImage(IMG_FINISH, noxWinHandle, x, y))
			{
				; 8. `ì „ì²´ ìºì‹œì ë¦½ ì„±ê³µí™”ë©´`ì´ ë…¸ì¶œë˜ë©´ í”„ë¡œê·¸ë¨ ì‹¤í–‰ì„ ì¤‘ì§€í•œë‹¤
				break
			}
		}
		
		; ìºì‹œ ì ë¦½ê°„ê²©ì€ 0.2ì´ˆë¡œ í•œë‹¤
		sleep, 200
	}
	
	; íŒŒë¼ë¯¸í„°ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë„ë¡ GUIë¥¼ í™œì„±í™”í•œë‹¤
	GuiControl, Enable, varNm
	GuiControl, Enable, varIdx
	
return

; ------------------------------------------------------------------------------------------

; ------------------------------------- ìºì‹œì ë¦½ ì¤‘ì§€ --------------------------------------

^]:: 	; ì¤‘ì§€ ë‹¨ì¶•í‚¤: Ctrl + ]
Stop: 	; ì¤‘ì§€ë²„íŠ¼
	isStopped := true
return

; ------------------------------------------------------------------------------------------

; ------------------------------------- í”„ë¡œê·¸ë¨ ì¢…ë£Œ --------------------------------------

^\:: 	; ì¢…ë£Œ ë‹¨ì¶•í‚¤: Ctrl + \
Exit: 	; ì¢…ë£Œë²„íŠ¼
GuiEscape:
GuiClose:
	ExitApp
return

; ------------------------------------------------------------------------------------------
